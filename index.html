<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="title">PDFページシャッフル | 無料オンラインツール</title>
    <meta name="description" data-i18n="metaDesc" content="PDFファイルのページをランダムにシャッフルできる無料オンラインツール。プライバシー保護、表紙・裏表紙の固定オプション付き。ブラウザ上で完結。">
    <meta name="keywords" data-i18n="keywords" content="PDF,シャッフル,ページ,ランダム,無料,オンライン,ツール,プライバシー">
    <meta name="author" content="PDF Shuffle Tool">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://tyama11.github.io/ShufflePDF/">
    <meta property="og:title" data-i18n="title" content="PDFページシャッフル | 無料オンラインツール">
    <meta property="og:description" data-i18n="metaDesc" content="PDFファイルのページをランダムにシャッフルできる無料オンラインツール。プライバシー保護、表紙・裏表紙の固定オプション付き。ブラウザ上で完結。">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://tyama11.github.io/ShufflePDF/">
    <meta property="twitter:title" data-i18n="title" content="PDFページシャッフル | 無料オンラインツール">
    <meta property="twitter:description" data-i18n="metaDesc" content="PDFファイルのページをランダムにシャッフルできる無料オンラインツール。プライバシー保護、表紙・裏表紙の固定オプション付き。ブラウザ上で完結。">
    
    <link rel="canonical" href="https://tyama11.github.io/ShufflePDF/">
    
    <!-- SEO: Language Alternates -->
    <link rel="alternate" hreflang="ja" href="https://tyama11.github.io/ShufflePDF/">
    <link rel="alternate" hreflang="en" href="https://tyama11.github.io/ShufflePDF/">
    <link rel="alternate" hreflang="es" href="https://tyama11.github.io/ShufflePDF/">
    <link rel="alternate" hreflang="zh" href="https://tyama11.github.io/ShufflePDF/">
    <link rel="alternate" hreflang="x-default" href="https://tyama11.github.io/ShufflePDF/">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js" defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* --- テーマ変数定義 --- */
        :root {
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --container-bg: rgba(255, 255, 255, 0.95);
            --text-color: #333;
            --text-color-light: #666;
            --panel-bg: rgba(102, 126, 234, 0.05);
            --panel-border: rgba(102, 126, 234, 0.2);
            --primary-color: #667eea;
            --primary-gradient: linear-gradient(135deg, #667eea, #764ba2);
            --switch-bg: #ccc;
            --footer-border: rgba(102, 126, 234, 0.2);
            --focus-outline: #005fcc;
        }

        html[data-theme="dark"] {
            --bg-gradient: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            --container-bg: rgba(45, 55, 72, 0.95);
            --text-color: #e2e8f0;
            --text-color-light: #cbd5e0;
            --panel-bg: rgba(255, 255, 255, 0.05);
            --panel-border: rgba(255, 255, 255, 0.2);
            --primary-color: #a3bffa;
            --primary-gradient: linear-gradient(135deg, #82aaff, #a3bffa);
            --switch-bg: #555;
            --footer-border: rgba(255, 255, 255, 0.1);
            --focus-outline: #5a9bff;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--container-bg);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        h1 {
            color: var(--text-color);
            margin-bottom: 30px;
            font-size: 2.5rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        header {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            text-align: center;
        }

        .theme-toggle-btn {
            position: absolute;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-color);
        }
        .theme-toggle-btn:hover {
            background: var(--panel-bg);
        }
        .theme-toggle-btn svg { width: 24px; height: 24px; }
        .theme-toggle-btn .moon { display: none; }

        .options-panel {
            background: var(--panel-bg);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid var(--panel-border);
        }

        .option-group {
            margin-bottom: 15px;
        }

        .option-group:last-child {
            margin-bottom: 0;
        }

        .switch-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 1.1rem;
            color: var(--text-color);
            font-weight: 500;
        }

        .switch-input {
            display: none;
        }

        .switch-slider {
            position: relative;
            width: 50px;
            height: 26px;
            background: var(--switch-bg);
            border-radius: 26px;
            transition: all 0.3s ease;
            margin-right: 15px;
        }

        .switch-slider::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .switch-input:checked + .switch-slider {
            background: var(--primary-gradient);
        }

        .switch-input:checked + .switch-slider::before {
            transform: translateX(24px);
        }

        .switch-text {
            user-select: none;
        }

        .upload-area {
            border: 3px dashed var(--primary-color);
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            background: var(--panel-bg);
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 30px;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: rgba(118, 75, 162, 0.1);
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: rgba(118, 75, 162, 0.15);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4rem;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .upload-text {
            color: var(--text-color-light);
            font-size: 1.2rem;
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            text-decoration: none;
            margin: 10px;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #28a745, #20c997);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-secondary:hover {
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }

        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
        }

        .status.info {
            background: rgba(102, 126, 234, 0.1);
            color: #313c94; /* コントラスト比を改善 */
            border: 2px solid rgba(102, 126, 234, 0.3);
        }

        .status.success {
            background: rgba(40, 167, 69, 0.1);
            color: #155724; /* コントラスト比を改善 */
            border: 2px solid rgba(40, 167, 69, 0.3);
        }

        .status.error {
            background: rgba(220, 53, 69, 0.1);
            color: #721c24; /* コントラスト比を改善 */
            border: 2px solid rgba(220, 53, 69, 0.3);
        }

        .controls {
            text-align: center;
            margin: 30px 0;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .spinner {
            border: 4px solid rgba(102, 126, 234, 0.1);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .page-info {
            background: var(--panel-bg);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .features {
            margin-top: 40px;
            text-align: center;
        }

        .features h2 {
            color: var(--text-color);
            margin-bottom: 20px;
        }

        .description {
            background: var(--panel-bg);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .description p {
            color: var(--text-color-light);
            font-size: 1rem;
            text-align: left;
            margin: 0;
        }

        .feature-list {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .feature {
            background: var(--panel-bg);
            padding: 15px 20px;
            border-radius: 10px;
            color: var(--primary-color);
            font-weight: bold;
        }

        .share-section {
            margin: 40px 0;
            text-align: center;
            padding: 25px;
            background: var(--panel-bg);
            border-radius: 15px;
            border: 2px solid var(--panel-border);
        }

        .share-section h3 {
            color: var(--text-color);
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .share-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .share-btn {
            display: inline-flex;
            align-items: center;
            padding: 12px 20px;
            border: none;
            border-radius: 50px;
            color: white;
            text-decoration: none;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .share-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .share-btn svg {
            width: 18px;
            height: 18px;
            margin-right: 8px;
        }

        .share-btn.twitter {
            background: linear-gradient(135deg, #1da1f2, #0d8bd9);
        }

        .share-btn.facebook {
            background: linear-gradient(135deg, #4267b2, #365899);
        }

        .share-btn.line {
            background: linear-gradient(135deg, #00c300, #00a000);
        }

        .share-btn.linkedin {
            background: linear-gradient(135deg, #0077b5, #005885);
        }

        .share-btn.copy {
            background: linear-gradient(135deg, #6c757d, #545b62);
        }

        .share-btn.copy.copied {
            background: linear-gradient(135deg, #28a745, #1e7e34);
        }

        .footer {
            margin-top: 50px;
            text-align: center;
            color: var(--text-color-light);
            font-size: 0.9rem;
            padding: 20px;
            border-top: 1px solid var(--footer-border);
        }

        .footer a {
            color: var(--primary-color);
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }
        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 2rem;
            }

            .upload-area {
                padding: 40px 15px;
            }

            .upload-icon {
                font-size: 3rem;
            }

            .feature-list {
                flex-direction: column;
                align-items: center;
            }

            .feature {
                width: 100%;
                max-width: 300px;
            }

            .share-buttons {
                flex-direction: column;
                align-items: center;
            }

            .share-btn {
                width: 100%;
                max-width: 250px;
                justify-content: center;
            }
        }

        /* アクセシビリティ対応 */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* ダークモードのアイコン切り替え */
        html[data-theme="dark"] .theme-toggle-btn .sun {
            display: none;
        }
        html[data-theme="dark"] .theme-toggle-btn .moon {
            display: block;
        }

        /* アクセシビリティ: フォーカス状態の強調 */
        :focus-visible {
            outline: 3px solid var(--focus-outline);
            outline-offset: 2px;
            border-radius: 4px;
        }

        /* --- FAQセクションのスタイル --- */
        .faq {
            margin-top: 50px;
            text-align: left;
        }
        .faq h2 {
            text-align: center;
            color: var(--text-color);
            margin-bottom: 25px;
        }
        .faq-item {
            background: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-radius: 10px;
            margin-bottom: 10px;
            transition: background-color 0.3s;
        }
        .faq-item summary {
            padding: 20px;
            font-weight: 600;
            cursor: pointer;
            color: var(--text-color);
            position: relative;
            list-style: none; /* デフォルトのマーカーを非表示 */
        }
        .faq-item summary::-webkit-details-marker { display: none; }
        .faq-item summary::after {
            content: '+';
            position: absolute;
            right: 20px;
            font-size: 1.5rem;
            transition: transform 0.2s;
        }
        .faq-item details[open] > summary::after { transform: rotate(45deg); }
        .faq-item p {
            padding: 0 20px 20px 20px;
            color: var(--text-color-light);
            line-height: 1.6;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 data-i18n="headline">📄 PDFページシャッフル</h1>
            <button id="theme-toggle" class="theme-toggle-btn" data-i18n="themeToggle" aria-label="Toggle theme">
                <svg class="sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.106a.75.75 0 010 1.06l-1.591 1.59a.75.75 0 11-1.06-1.06l1.59-1.59a.75.75 0 011.06 0zm-11.457 11.457a.75.75 0 01-1.06 0l-1.59-1.591a.75.75 0 111.06-1.06l1.59 1.59a.75.75 0 010 1.061zm11.457 0a.75.75 0 010-1.06l1.59-1.59a.75.75 0 111.06 1.06l-1.59 1.59a.75.75 0 01-1.06 0zM12 7.5a4.5 4.5 0 100 9 4.5 4.5 0 000-9zM5.106 18.894a.75.75 0 01-1.06 0l-1.59-1.59a.75.75 0 010-1.06l1.59-1.59a.75.75 0 111.06 1.06l-1.59 1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5h2.25a.75.75 0 01.75.75zM4.5 12a.75.75 0 01.75-.75h2.25a.75.75 0 010 1.5H5.25a.75.75 0 01-.75-.75zM12 19.5a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 19.5z"/></svg>
                <svg class="moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M9.528 1.718a.75.75 0 01.162.819A8.97 8.97 0 009 6a9 9 0 009 9 8.97 8.97 0 004.463-.945.75.75 0 01.981.981A10.503 10.503 0 0118 18a10.5 10.5 0 01-10.5-10.5c0-1.562.32-3.056.9-4.402a.75.75 0 01.819-.162z" clip-rule="evenodd" /></svg>
            </button>
        </header>

        <main>
            <section class="options-panel">
                <div class="option-group">
                    <label class="switch-label">
                        <input type="checkbox" id="preserveFirstPage" class="switch-input">
                        <span class="switch-slider"></span>
                        <span class="switch-text" data-i18n="fixFirst">最初のページを固定</span>
                    </label>
                </div>
                <div class="option-group">
                    <label class="switch-label">
                        <input type="checkbox" id="preserveLastPage" class="switch-input">
                        <span class="switch-slider"></span>
                        <span class="switch-text" data-i18n="fixLast">最後のページを固定</span>
                    </label>
                </div>
                <div class="option-group">
                    <label class="switch-label">
                        <input type="checkbox" id="preserveSpreads" class="switch-input">
                        <span class="switch-slider"></span>
                        <span class="switch-text" data-i18n="fixSpreads">見開きを維持 (2ページ単位)</span>
                    </label>
                </div>
            </section>

            <section class="upload-area" id="uploadArea">
                <div class="upload-icon">📁</div>
                <div class="upload-text" data-i18n="dropHere">PDFファイルをここにドラッグ＆ドロップ</div>
                <div class="upload-text" data-i18n="or">または</div>
                <button class="btn" onclick="document.getElementById('fileInput').click()" data-i18n="chooseFile">
                    ファイルを選択
                </button>
                <input type="file" id="fileInput" class="file-input" accept=".pdf">
            </section>

            <div id="status" class="status" style="display: none;" aria-live="polite"></div>

            <div class="loading" id="loading" role="status" aria-live="polite">
                <div class="spinner"></div>
                <div data-i18n="loadingText">PDFを処理中...</div>
            </div>

            <div id="pageInfo" class="page-info" style="display: none;">
                <h3 data-i18n="pageInfoTitle">📋 PDF情報</h3>
                <div id="pageCount"></div>
            </div>

            <div class="controls">
                <button class="btn" id="shuffleBtn" onclick="shufflePDF()" disabled data-i18n="shuffleBtnText">
                    🔀 ページをシャッフル
                </button>
                <button class="btn btn-secondary" id="downloadBtn" onclick="downloadShuffledPDF()" disabled style="display: none;" data-i18n="downloadBtnText">
                    💾 シャッフル済みPDFをダウンロード
                </button>
            </div>

            <section class="features">
                <h2 data-i18n="featuresTitle">✨ 機能</h2>
                <div class="description">
                    <p data-i18n="descriptionText">このPDFページシャッフルツールは、PDFファイルのページをランダムに並び替えることができるWebアプリケーションです。ブラウザ上で完結するため、ファイルがサーバーに送信されることなく、プライバシーが完全に保護されます。表紙や裏表紙など、位置を変えたくないページは固定オプションで保護できます。新たに見開き（2ページ単位）を維持したままシャッフルする機能も追加され、本のような形式のPDFにも対応しました。処理後は即座にダウンロードが可能で、元のファイル名に「_shuffled」が付加されます。</p>
                </div>
                <div class="feature-list">
                    <div class="feature" data-i18n="featureShuffle">🔀 ランダムシャッフル</div>
                    <div class="feature" data-i18n="featureFix">📌 ページ固定オプション</div>
                    <div class="feature" data-i18n="featureSpreads">📖 見開き維持シャッフル</div>
                    <div class="feature" data-i18n="featureAllPages">📄 全ページ対応</div>
                    <div class="feature" data-i18n="featureDownload">💾 即座にダウンロード</div>
                    <div class="feature" data-i18n="featurePrivacy">🔒 プライバシー保護</div>
                </div>
            </section>

            <section class="share-section">
                <h3 data-i18n="shareTitle">📢 このツールをシェア</h3>
                <div class="share-buttons">
                    <button class="share-btn twitter" onclick="shareToTwitter()" aria-label="Xでシェア">
                        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                            <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                        </svg>
                        <span data-i18n="shareTwitter">X でシェア</span>
                    </button>
                    <button class="share-btn copy" onclick="copyLink()" id="copyBtn" aria-label="リンクをコピー">
                        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                            <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                        </svg>
                        <span data-i18n="copyLink">リンクをコピー</span>
                    </button>
                </div>
            </section>

            <section class="faq">
                <h2 data-i18n="faqTitle">よくある質問 (FAQ)</h2>
                <div class="faq-item">
                    <details>
                        <summary data-i18n="faqQ1">このツールは本当に無料ですか？</summary>
                        <p data-i18n="faqA1">はい、完全に無料です。すべての機能を登録不要、無制限でご利用いただけます。</p>
                    </details>
                </div>
                <div class="faq-item">
                    <details>
                        <summary data-i18n="faqQ2">ファイルは安全ですか？プライバシーは保護されますか？</summary>
                        <p data-i18n="faqA2">はい、安全です。このツールはあなたのブラウザ上でのみ動作し、PDFファイルがサーバーにアップロードされることは一切ありません。あなたのプライバシーは完全に保護されます。</p>
                    </details>
                </div>
                <div class="faq-item">
                    <details>
                        <summary data-i18n="faqQ3">どんなPDFファイルでも使えますか？</summary>
                        <p data-i18n="faqA3">標準的なPDFファイルであれば、ほとんどのものが利用可能です。ただし、パスワードで保護されているファイルや、特殊な形式のファイルは正しく処理できない場合があります。</p>
                    </details>
                </div>
                <div class="faq-item">
                    <details>
                        <summary data-i18n="faqQ4">シャッフル後に元に戻すことはできますか？</summary>
                        <p data-i18n="faqA4">シャッフル処理は元のファイルを変更しません。シャッフル結果が気に入らない場合は、ページを再読み込みして元のファイルを再度アップロードし、もう一度シャッフルをお試しください。</p>
                    </details>
                </div>
                <div class="faq-item">
                    <details>
                        <summary data-i18n="faqQ5">「見開きを維持」とは何ですか？</summary>
                        <p data-i18n="faqA5">このオプションを有効にすると、ページが2ページずつのペア（例: 1-2ページ、3-4ページ）として扱われ、そのペア単位でシャッフルされます。本や雑誌のように見開きでデザインされたPDFに便利です。「最初のページを固定」を併用すると、最初のペア（1-2ページ）が先頭に固定されます。</p>
                    </details>
                </div>
            </section>
        </main>

        <footer class="footer">
            <p data-i18n="footerText1">&copy; 2025 PDF Shuffle Tool. ブラウザ上で動作するオープンソースツールです。</p>
            <p data-i18n="footerText2">機能追加や不具合があれば <a href="https://github.com/tyama11/ShufflePDF" target="_blank" rel="noopener">GitHub</a> にお知らせください。</p>
        </footer>
    </div>

    <script>
        // 多言語翻訳データ
        const translations = {
            ja: {
                title: "PDFページシャッフル | 無料オンラインツール",
                metaDesc: "PDFファイルのページをランダムにシャッフルできる無料オンラインツール。プライバシー保護、表紙・裏表紙の固定オプション付き。ブラウザ上で完結。",
                keywords: "PDF,シャッフル,ページ,ランダム,無料,オンライン,ツール,プライバシー",
                headline: "📄 PDFページシャッフル",
                fixFirst: "最初のページを固定",
                fixLast: "最後のページを固定",
                fixSpreads: "見開きを維持 (2ページ単位)",
                dropHere: "PDFファイルをここにドラッグ＆ドロップ",
                or: "または",
                chooseFile: "ファイルを選択",
                loadingText: "PDFを処理中...",
                pageInfoTitle: "📋 PDF情報",
                pageCountText: "総ページ数: ${pageCount}ページ",
                shuffleBtnText: "🔀 ページをシャッフル",
                downloadBtnText: "💾 シャッフル済みPDFをダウンロード",
                featuresTitle: "✨ 機能",
                descriptionText: "このPDFページシャッフルツールは、PDFファイルのページをランダムに並び替えることができるWebアプリケーションです。ブラウザ上で完結するため、ファイルがサーバーに送信されることなく、プライバシーが完全に保護されます。表紙や裏表紙など、位置を変えたくないページは固定オプションで保護できます。新たに見開き（2ページ単位）を維持したままシャッフルする機能も追加され、本のような形式のPDFにも対応しました。処理後は即座にダウンロードが可能で、元のファイル名に「_shuffled」が付加されます。",
                featureShuffle: "🔀 ランダムシャッフル",
                featureFix: "📌 ページ固定オプション",
                featureSpreads: "📖 見開き維持シャッフル",
                featureAllPages: "📄 全ページ対応",
                featureDownload: "💾 即座にダウンロード",
                featurePrivacy: "🔒 プライバシー保護",
                shareTitle: "📢 このツールをシェア",
                shareTwitter: "X でシェア",
                copyLink: "リンクをコピー",
                copyBtnCopied: "コピー完了！",
                footerText1: "© 2025 PDF Shuffle Tool. ブラウザ上で動作するオープンソースツールです。",
                footerText2: '機能追加や不具合があれば <a href="https://github.com/tyama11/ShufflePDF" target="_blank" rel="noopener">GitHub</a> にお知らせください。',
                statusPdfOnly: "PDFファイルを選択してください。",
                statusFileLoaded: 'PDFファイル "${fileName}" を読み込みました！',
                statusLoadError: "PDFファイルの読み込みに失敗しました。破損していないか確認してください。",
                statusSelectFirst: "まずPDFファイルを選択してください。",
                statusNoPages: "PDFにページが含まれていません。",
                statusAllFixed: "全てのページが固定されているため、順序は変更されませんでした。",
                statusShuffled: "${shuffledCount}ページをシャッフルしました！",
                statusShuffledWithFixed: "${shuffledCount}ページをシャッフルしました！ (${fixedPages}は固定)",
                statusShuffledSpreads: "${shuffledCount}ペアをシャッフルしました！",
                statusShuffledSpreadsWithFixed: "${shuffledCount}ペアをシャッフルしました！ (${fixedPages}は固定)",
                firstPage: "最初のページ",
                lastPage: "最後のページ",
                firstSpread: "最初の見開き",
                lastSpread: "最後の見開き",
                statusShuffleError: "PDFのシャッフルに失敗しました。ファイルが破損していないか確認してください。",
                statusShuffleFirst: "まずPDFをシャッフルしてください。",
                statusDownloaded: "シャッフル済みPDFをダウンロードしました！",
                statusDownloadError: "ファイルのダウンロードに失敗しました。",
                statusCopySuccess: "リンクをクリップボードにコピーしました！",
                statusCopyError: "リンクのコピーに失敗しました。",
                hashtags: "PDF,シャッフル,無料ツール,オンライン",
                themeToggle: "テーマを切り替え (ライト/ダーク)",
                faqTitle: "よくある質問 (FAQ)",
                faqQ1: "このツールは本当に無料ですか？",
                faqA1: "はい、完全に無料です。すべての機能を登録不要、無制限でご利用いただけます。",
                faqQ2: "ファイルは安全ですか？プライバシーは保護されますか？",
                faqA2: "はい、安全です。このツールはあなたのブラウザ上でのみ動作し、PDFファイルがサーバーにアップロードされることは一切ありません。あなたのプライバシーは完全に保護されます。",
                faqQ3: "どんなPDFファイルでも使えますか？",
                faqA3: "標準的なPDFファイルであれば、ほとんどのものが利用可能です。ただし、パスワードで保護されているファイルや、特殊な形式のファイルは正しく処理できない場合があります。",
                faqQ4: "シャッフル後に元に戻すことはできますか？",
                faqA4: "シャッフル処理は元のファイルを変更しません。シャッフル結果が気に入らない場合は、ページを再読み込みして元のファイルを再度アップロードし、もう一度シャッフルをお試しください。",
                faqQ5: "「見開きを維持」とは何ですか？",
                faqA5: "このオプションを有効にすると、ページが2ページずつのペア（例: 1-2ページ、3-4ページ）として扱われ、そのペア単位でシャッフルされます。本や雑誌のように見開きでデザインされたPDFに便利です。「最初のページを固定」を併用すると、最初のペア（1-2ページ）が先頭に固定されます。",
            },
            en: {
                title: "PDF Page Shuffle | Free Online Tool",
                metaDesc: "Free online tool to shuffle PDF pages randomly. Privacy protected, with options to lock cover and back pages. Works entirely in your browser.",
                keywords: "PDF,shuffle,page,random,free,online,tool,privacy",
                headline: "📄 PDF Page Shuffle",
                fixFirst: "Fix the first page",
                fixLast: "Fix the last page",
                fixSpreads: "Preserve spreads (2-page units)",
                dropHere: "Drag & drop your PDF file here",
                or: "or",
                chooseFile: "Choose file",
                loadingText: "Processing PDF...",
                pageInfoTitle: "📋 PDF Information",
                pageCountText: "Total pages: ${pageCount}",
                shuffleBtnText: "🔀 Shuffle Pages",
                downloadBtnText: "💾 Download Shuffled PDF",
                featuresTitle: "✨ Features",
                descriptionText: "This PDF Page Shuffle tool is a web application that allows you to randomly reorder the pages of a PDF file. Since it runs entirely in your browser, your files are not sent to a server, ensuring complete privacy. You can protect pages you don't want to move, such as the cover or back page, with the fix option. A new feature to shuffle while preserving spreads (2-page units) has been added, making it suitable for book-like PDFs. After processing, the file is available for immediate download, with '_shuffled' appended to the original file name.",
                featureShuffle: "🔀 Random Shuffle",
                featureFix: "📌 Page Fix Option",
                featureSpreads: "📖 Preserve Spreads Shuffle",
                featureAllPages: "📄 All Pages Supported",
                featureDownload: "💾 Instant Download",
                featurePrivacy: "🔒 Privacy Protection",
                shareTitle: "📢 Share This Tool",
                shareTwitter: "Share on X",
                copyLink: "Copy Link",
                copyBtnCopied: "Copied!",
                footerText1: "© 2025 PDF Shuffle Tool. An open-source tool that runs in your browser.",
                footerText2: 'If you have feature requests or find bugs, please report them on <a href="https://github.com/tyama11/ShufflePDF" target="_blank" rel="noopener">GitHub</a>.',
                statusPdfOnly: "Please select a PDF file.",
                statusFileLoaded: 'Loaded PDF file "${fileName}"!',
                statusLoadError: "Failed to load PDF file. Please check if it is corrupted.",
                statusSelectFirst: "Please select a PDF file first.",
                statusNoPages: "The PDF contains no pages.",
                statusAllFixed: "All pages are fixed, so the order was not changed.",
                statusShuffled: "Shuffled ${shuffledCount} pages!",
                statusShuffledWithFixed: "Shuffled ${shuffledCount} pages! (${fixedPages} are fixed)",
                statusShuffledSpreads: "Shuffled ${shuffledCount} spreads!",
                statusShuffledSpreadsWithFixed: "Shuffled ${shuffledCount} spreads! (${fixedPages} are fixed)",
                firstPage: "the first page",
                lastPage: "the last page",
                firstSpread: "the first spread",
                lastSpread: "the last spread",
                statusShuffleError: "Failed to shuffle PDF. Please check if the file is corrupted.",
                statusShuffleFirst: "Please shuffle the PDF first.",
                statusDownloaded: "Downloaded the shuffled PDF!",
                statusDownloadError: "Failed to download the file.",
                statusCopySuccess: "Copied the link to your clipboard!",
                statusCopyError: "Failed to copy the link.",
                hashtags: "PDF,Shuffle,FreeTool,OnlineTool",
                themeToggle: "Toggle theme (Light/Dark)",
                faqTitle: "Frequently Asked Questions (FAQ)",
                faqQ1: "Is this tool really free?",
                faqA1: "Yes, it is completely free. All features are available without registration or limits.",
                faqQ2: "Are my files secure? Is my privacy protected?",
                faqA2: "Yes, it's secure. This tool operates entirely within your browser. Your PDF files are never uploaded to a server, ensuring your privacy is fully protected.",
                faqQ3: "Can I use any PDF file?",
                faqA3: "Most standard PDF files are supported. However, password-protected or specially formatted files may not be processed correctly.",
                faqQ4: "Can I undo the shuffle?",
                faqA4: "The shuffling process does not alter your original file. If you are not satisfied with the result, simply reload the page, upload the original file again, and try shuffling once more.",
                faqQ5: "What does 'Preserve Spreads' mean?",
                faqA5: "When this option is enabled, pages are treated as 2-page pairs (e.g., pages 1-2, 3-4) and shuffled as units. This is useful for PDFs designed with facing pages, like books or magazines. If used with 'Fix the first page', the first spread (pages 1-2) will be locked at the beginning.",
            },
            zh: {
                title: "PDF页面随机排序 | 免费在线工具",
                metaDesc: "免费的在线工具，可随机打乱PDF页面顺序。保护您的隐私，可选择固定首页和末页。完全在您的浏览器中运行。",
                keywords: "PDF,随机排序,页面,打乱顺序,免费,在线,工具,隐私",
                headline: "📄 PDF页面随机排序",
                fixFirst: "固定第一页",
                fixLast: "固定最后一页",
                fixSpreads: "保持跨页 (2页单位)",
                dropHere: "将PDF文件拖放到此处",
                or: "或",
                chooseFile: "选择文件",
                loadingText: "正在处理PDF...",
                pageInfoTitle: "📋 PDF信息",
                pageCountText: "总页数: ${pageCount}页",
                shuffleBtnText: "🔀 随机排序页面",
                downloadBtnText: "💾 下载排序后的PDF",
                featuresTitle: "✨ 功能特性",
                descriptionText: "此PDF页面随机排序工具是一个Web应用程序，可让您随机重排PDF文件的页面顺序。由于它完全在您的浏览器中运行，您的文件不会被发送到服务器，从而确保了完全的隐私。您可以使用固定选项保护不想移动的页面，例如封面或封底。新增了在保持跨页（2页单位）的同时进行排序的功能，使其也适用于书籍样式的PDF。处理后，文件可立即下载，文件名后会附加“_shuffled”。",
                featureShuffle: "🔀 随机排序",
                featureFix: "📌 页面固定选项",
                featureSpreads: "📖 保持跨页排序",
                featureAllPages: "📄 支持所有页面",
                featureDownload: "💾 即时下载",
                featurePrivacy: "🔒 隐私保护",
                shareTitle: "📢 分享此工具",
                shareTwitter: "在 X 上分享",
                copyLink: "复制链接",
                copyBtnCopied: "已复制！",
                footerText1: "© 2025 PDF Shuffle Tool. 一个在浏览器中运行的开源工具。",
                footerText2: '如果您有功能建议或发现错误，请在 <a href="https://github.com/tyama11/ShufflePDF" target="_blank" rel="noopener">GitHub</a> 上报告。',
                statusPdfOnly: "请选择一个PDF文件。",
                statusFileLoaded: '已加载PDF文件 "${fileName}"！',
                statusLoadError: "加载PDF文件失败。请检查文件是否损坏。",
                statusSelectFirst: "请先选择一个PDF文件。",
                statusNoPages: "该PDF不包含任何页面。",
                statusAllFixed: "所有页面均已固定，因此顺序未改变。",
                statusShuffled: "已随机排序 ${shuffledCount} 个页面！",
                statusShuffledWithFixed: "已随机排序 ${shuffledCount} 个页面！ (${fixedPages}已固定)",
                statusShuffledSpreads: "已随机排序 ${shuffledCount} 个跨页！",
                statusShuffledSpreadsWithFixed: "已随机排序 ${shuffledCount} 个跨页！ (${fixedPages}已固定)",
                firstPage: "第一页",
                lastPage: "最后一页",
                firstSpread: "第一个跨页",
                lastSpread: "最后一个跨页",
                statusShuffleError: "PDF排序失败。请检查文件是否损坏。",
                statusShuffleFirst: "请先对PDF进行排序。",
                statusDownloaded: "已下载排序后的PDF！",
                statusDownloadError: "文件下载失败。",
                statusCopySuccess: "已将链接复制到剪贴板！",
                statusCopyError: "复制链接失败。",
                hashtags: "PDF,随机排序,免费工具,在线工具",
                themeToggle: "切换主题 (亮/暗)",
                faqTitle: "常见问题 (FAQ)",
                faqQ1: "这个工具真的免费吗？",
                faqA1: "是的，完全免费。所有功能无需注册，无限制使用。",
                faqQ2: "我的文件安全吗？隐私会受到保护吗？",
                faqA2: "是的，非常安全。此工具完全在您的浏览器中运行，PDF文件绝不会上传到服务器。您的隐私将得到完全保护。",
                faqQ3: "任何PDF文件都可以使用吗？",
                faqA3: "大多数标准的PDF文件都受支持。但是，受密码保护或特殊格式的文件可能无法正确处理。",
                faqQ4: "随机排序后可以撤销吗？",
                faqA4: "排序过程不会修改您的原始文件。如果您对结果不满意，只需重新加载页面，再次上传原始文件，然后重试排序即可。",
                faqQ5: "“保持跨页”是什么意思？",
                faqA5: "启用此选项后，页面将被视为2页的配对（例如，第1-2页，第3-4页），并以这些配对为单位进行随机排序。这对于设计为对开页的PDF（如书籍或杂志）非常有用。如果与“固定第一页”一起使用，第一个跨页（第1-2页）将被锁定在开头。",
            },
            es: {
                title: "Mezclar Páginas de PDF | Herramienta Gratuita en Línea",
                metaDesc: "Herramienta gratuita en línea para mezclar aleatoriamente las páginas de un archivo PDF. Privacidad protegida, con opciones para fijar la portada y la contraportada. Funciona completamente en su navegador.",
                keywords: "PDF, mezclar, página, aleatorio, gratis, en línea, herramienta, privacidad",
                headline: "📄 Mezclador de Páginas PDF",
                fixFirst: "Fijar la primera página",
                fixLast: "Fijar la última página",
                fixSpreads: "Conservar pliegos (unidades de 2 páginas)",
                dropHere: "Arrastra y suelta tu archivo PDF aquí",
                or: "o",
                chooseFile: "Seleccionar archivo",
                loadingText: "Procesando PDF...",
                pageInfoTitle: "📋 Información del PDF",
                pageCountText: "Páginas totales: ${pageCount}",
                shuffleBtnText: "🔀 Mezclar Páginas",
                downloadBtnText: "💾 Descargar PDF Mezclado",
                featuresTitle: "✨ Características",
                descriptionText: "Esta herramienta para mezclar páginas de PDF es una aplicación web que le permite reordenar aleatoriamente las páginas de un archivo PDF. Como funciona completamente en su navegador, sus archivos no se envían a un servidor, garantizando una privacidad completa. Puede proteger las páginas que no desea mover, como la portada o la contraportada, con la opción de fijar. Se ha añadido una nueva función para mezclar conservando los pliegos (unidades de 2 páginas), lo que la hace adecuada para PDF con formato de libro. Después del procesamiento, el archivo está disponible para su descarga inmediata, con '_shuffled' añadido al nombre del archivo original.",
                featureShuffle: "🔀 Mezcla Aleatoria",
                featureFix: "📌 Opción para Fijar Páginas",
                featureSpreads: "📖 Mezcla Conservando Pliegos",
                featureAllPages: "📄 Compatible con Todas las Páginas",
                featureDownload: "💾 Descarga Instantánea",
                featurePrivacy: "🔒 Protección de la Privacidad",
                shareTitle: "📢 Comparte esta Herramienta",
                shareTwitter: "Compartir en X",
                copyLink: "Copiar Enlace",
                copyBtnCopied: "¡Copiado!",
                footerText1: "© 2025 PDF Shuffle Tool. Una herramienta de código abierto que funciona en su navegador.",
                footerText2: 'Si tiene solicitudes de funciones o encuentra errores, por favor repórtelos en <a href="https://github.com/tyama11/ShufflePDF" target="_blank" rel="noopener">GitHub</a>.',
                statusPdfOnly: "Por favor, seleccione un archivo PDF.",
                statusFileLoaded: '¡Archivo PDF "${fileName}" cargado!',
                statusLoadError: "Error al cargar el archivo PDF. Por favor, compruebe si está dañado.",
                statusSelectFirst: "Por favor, seleccione primero un archivo PDF.",
                statusNoPages: "El PDF no contiene páginas.",
                statusAllFixed: "Todas las páginas están fijas, por lo que el orden no se ha modificado.",
                statusShuffled: "¡Se han mezclado ${shuffledCount} páginas!",
                statusShuffledWithFixed: "¡Se han mezclado ${shuffledCount} páginas! (${fixedPages} están fijas)",
                statusShuffledSpreads: "¡Se han mezclado ${shuffledCount} pliegos!",
                statusShuffledSpreadsWithFixed: "¡Se han mezclado ${shuffledCount} pliegos! (${fixedPages} están fijos)",
                firstPage: "la primera página",
                lastPage: "la última página",
                firstSpread: "el primer pliego",
                lastSpread: "el último pliego",
                statusShuffleError: "Error al mezclar el PDF. Por favor, compruebe si el archivo está dañado.",
                statusShuffleFirst: "Por favor, mezcle primero el PDF.",
                statusDownloaded: "¡PDF mezclado descargado!",
                statusDownloadError: "Error al descargar el archivo.",
                statusCopySuccess: "¡Enlace copiado al portapapeles!",
                statusCopyError: "Error al copiar el enlace.",
                hashtags: "PDF,Mezclar,HerramientaGratuita,Online",
                themeToggle: "Cambiar tema (Claro/Oscuro)",
                faqTitle: "Preguntas Frecuentes (FAQ)",
                faqQ1: "¿Es esta herramienta realmente gratuita?",
                faqA1: "Sí, es completamente gratuita. Todas las funciones están disponibles sin necesidad de registro y sin límites.",
                faqQ2: "¿Están seguros mis archivos? ¿Está protegida mi privacidad?",
                faqA2: "Sí, es seguro. Esta herramienta funciona completamente dentro de su navegador. Sus archivos PDF nunca se suben a un servidor, lo que garantiza que su privacidad esté totalmente protegida.",
                faqQ3: "¿Puedo usar cualquier archivo PDF?",
                faqA3: "La mayoría de los archivos PDF estándar son compatibles. Sin embargo, los archivos protegidos con contraseña o con formatos especiales pueden no procesarse correctamente.",
                faqQ4: "¿Puedo deshacer la mezcla?",
                faqA4: "El proceso de mezcla no altera su archivo original. Si no está satisfecho con el resultado, simplemente recargue la página, vuelva a subir el archivo original e intente mezclarlo de nuevo.",
                faqQ5: "¿Qué significa 'Conservar pliegos'?",
                faqA5: "Cuando esta opción está habilitada, las páginas se tratan como pares de 2 páginas (por ejemplo, páginas 1-2, 3-4) y se mezclan como unidades. Esto es útil para PDF diseñados con páginas enfrentadas, como libros o revistas. Si se usa con 'Fijar la primera página', el primer pliego (páginas 1-2) quedará bloqueado al principio.",
            }
        };

        function getUserLanguage() {
            const lang = navigator.language.toLowerCase();
            if (lang.startsWith("ja")) {
                return "ja";
            }
            if (lang.startsWith("es")) {
                return "es";
            }
            if (lang.startsWith("zh")) {
                return "zh";
            }
            return "en";
        }
        const userLang = getUserLanguage();
        document.documentElement.lang = userLang;

        // --- テーマ切り替え機能 ---
        const themeToggle = document.getElementById('theme-toggle');

        const applyTheme = (theme) => {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        };

        const toggleTheme = () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
        };

        themeToggle.addEventListener('click', toggleTheme);

        // 初期テーマ設定
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (savedTheme) {
            applyTheme(savedTheme);
        } else {
            applyTheme(prefersDark ? 'dark' : 'light');
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll("[data-i18n]").forEach(el => {
                const key = el.getAttribute("data-i18n");
                const translation = translations[userLang]?.[key];
                if (translation) {
                    if (el.tagName.toLowerCase() === "meta") {
                        el.setAttribute("content", translation);
                    } else if (el.tagName.toLowerCase() === "title") {
                        el.textContent = translation;
                    } else if (key === 'shareTwitter') {
                        el.parentElement.setAttribute('aria-label', translation);
                        el.textContent = translation;
                    } else if (key === 'copyLink') {
                        el.parentElement.setAttribute('aria-label', translation);
                        el.textContent = translation;
                    } else if (key === 'themeToggle') {
                        el.setAttribute('aria-label', translation);
                    } else if (key === 'footerText2') {
                        el.innerHTML = translation;
                    } else {
                        el.textContent = translation;
                    }
                }
            });
        });

        let originalPdfBytes = null;
        let shuffledPdfBytes = null;
        let originalFileName = '';

        // ドラッグ＆ドロップ機能
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const status = document.getElementById('status');
        const loading = document.getElementById('loading');
        const pageInfo = document.getElementById('pageInfo');
        const shuffleBtn = document.getElementById('shuffleBtn');
        const downloadBtn = document.getElementById('downloadBtn');

        // イベントリスナーの設定
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        uploadArea.addEventListener('drop', handleDrop);
        fileInput.addEventListener('change', handleFileInput);

        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave() {
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileInput(e) {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        }

        function showStatus(key, type, replacements = {}) {
            let message = translations[userLang][key] || key;
            for (const placeholder in replacements) {
                message = message.replace(`\${${placeholder}}`, replacements[placeholder]);
            }
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
        }

        function hideStatus() {
            status.style.display = 'none';
        }

        function showLoading(show = true) {
            loading.style.display = show ? 'block' : 'none';
        }

        async function handleFile(file) {
            if (file.type !== 'application/pdf') {
                showStatus('statusPdfOnly', 'error');
                return;
            }

            originalFileName = file.name;
            showLoading(true);
            hideStatus();

            try {
                const arrayBuffer = await file.arrayBuffer();
                originalPdfBytes = new Uint8Array(arrayBuffer);
                
                // PDF情報を取得
                const pdfDoc = await PDFLib.PDFDocument.load(originalPdfBytes);
                const pageCount = pdfDoc.getPageCount();
                
                document.getElementById('pageCount').textContent = translations[userLang].pageCountText.replace('${pageCount}', pageCount);
                pageInfo.style.display = 'block';
                shuffleBtn.disabled = false;
                downloadBtn.style.display = 'none';
                shuffledPdfBytes = null;
                
                showStatus('statusFileLoaded', 'success', { fileName: file.name });
            } catch (error) {
                console.error('PDF読み込みエラー:', error);
                showStatus('statusLoadError', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function shufflePDF() {
            if (!originalPdfBytes) {
                showStatus('statusSelectFirst', 'error');
                return;
            }

            showLoading(true);
            shuffleBtn.disabled = true;
            hideStatus();

            try {
                // 元のPDFを読み込み
                const originalDoc = await PDFLib.PDFDocument.load(originalPdfBytes);
                const pageCount = originalDoc.getPageCount();

                if (pageCount === 0) {
                    showStatus('statusNoPages', 'error');
                    showLoading(false);
                    shuffleBtn.disabled = false;
                    return;
                }

                // 新しいPDFドキュメントを作成
                const newDoc = await PDFLib.PDFDocument.create();

                // オプション設定を取得
                const preserveFirst = document.getElementById('preserveFirstPage').checked;
                const preserveLast = document.getElementById('preserveLastPage').checked;
                const preserveSpreads = document.getElementById('preserveSpreads').checked;

                let units = [];
                if (preserveSpreads) {
                    for (let i = 0; i < pageCount; i += 2) {
                        if (i + 1 < pageCount) {
                            units.push([i, i + 1]);
                        } else {
                            units.push([i]);
                        }
                    }
                } else {
                    for (let i = 0; i < pageCount; i++) {
                        units.push([i]);
                    }
                }

                const prefixUnits = [];
                if (preserveFirst && units.length > 0) {
                    prefixUnits.push(units.shift());
                }

                const suffixUnits = [];
                if (preserveLast && units.length > 0) {
                    suffixUnits.unshift(units.pop());
                }

                const shuffledUnitsCount = units.length;
                if (units.length > 1) {
                    shuffleArray(units);
                }

                const finalOrder = [...prefixUnits.flat(), ...units.flat(), ...suffixUnits.flat()];

                if (finalOrder.length > 0) {
                    const [copiedPages] = await newDoc.copyPages(originalDoc, finalOrder);
                    copiedPages.forEach(page => newDoc.addPage(page));
                }

                if (shuffledUnitsCount === 0 && (prefixUnits.length > 0 || suffixUnits.length > 0)) {
                    showStatus('statusAllFixed', 'info');
                } else if (shuffledUnitsCount > 0) {
                    const fixedPageParts = [];
                    if (prefixUnits.length > 0) fixedPageParts.push(translations[userLang][preserveSpreads ? 'firstSpread' : 'firstPage']);
                    if (suffixUnits.length > 0) fixedPageParts.push(translations[userLang][preserveSpreads ? 'lastSpread' : 'lastPage']);

                    if (fixedPageParts.length > 0) {
                        const conjunctions = { ja: 'と', en: ' and ', zh: '和', es: ' y ' };
                        const fixedPages = fixedPageParts.join(conjunctions[userLang] || ' and ');
                        const statusKey = preserveSpreads ? 'statusShuffledSpreadsWithFixed' : 'statusShuffledWithFixed';
                        showStatus(statusKey, 'success', { shuffledCount: shuffledUnitsCount, fixedPages });
                    } else {
                        const statusKey = preserveSpreads ? 'statusShuffledSpreads' : 'statusShuffled';
                        showStatus(statusKey, 'success', { shuffledCount: shuffledUnitsCount });
                    }
                }

                // PDFをバイト配列に変換
                shuffledPdfBytes = await newDoc.save();
                downloadBtn.disabled = false;
                downloadBtn.style.display = 'inline-block';
                
            } catch (error) {
                console.error('シャッフルエラー:', error);
                showStatus('statusShuffleError', 'error');
            } finally {
                showLoading(false);
                shuffleBtn.disabled = false;
            }
        }

        function shuffleArray(array) {
            // Fisher-Yates シャッフルアルゴリズム
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function downloadShuffledPDF() {
            if (!shuffledPdfBytes) {
                showStatus('statusShuffleFirst', 'error');
                return;
            }

            try {
                const blob = new Blob([shuffledPdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                const baseName = originalFileName.replace(/\.pdf$/i, '');
                a.download = `${baseName}_shuffled.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showStatus('statusDownloaded', 'success');
            } catch (error) {
                console.error('ダウンロードエラー:', error);
                showStatus('statusDownloadError', 'error');
            }
        }

        // ソーシャルメディア共有機能
        function shareToTwitter() {
            const url = encodeURIComponent(window.location.href);
            const text = encodeURIComponent(translations[userLang].metaDesc);
            const hashtags = encodeURIComponent(translations[userLang].hashtags);
            
            const twitterUrl = `https://twitter.com/intent/tweet?url=${url}&text=${text}&hashtags=${hashtags}`;
            window.open(twitterUrl, '_blank', 'width=550,height=420');
        }

        function copyLink() {
            const copyBtn = document.getElementById('copyBtn');
            const url = window.location.href;
            
            if (navigator.clipboard && window.isSecureContext) {
                // モダンブラウザ対応
                navigator.clipboard.writeText(url).then(() => {
                    showCopySuccess();
                }).catch(() => {
                    fallbackCopyTextToClipboard(url);
                });
            } else {
                // 古いブラウザ対応
                fallbackCopyTextToClipboard(url);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            
            // 画面外に配置
            textArea.style.position = "fixed";
            textArea.style.left = "-999999px";
            textArea.style.top = "-999999px";
            document.body.appendChild(textArea);
            
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopySuccess();
                } else {
                    showStatus('statusCopyError', 'error');
                }
            } catch (err) {
                showStatus('statusCopyError', 'error');
            }
            
            document.body.removeChild(textArea);
        }

        function showCopySuccess() {
            const copyBtn = document.getElementById('copyBtn');
            const originalContent = copyBtn.innerHTML;
            
            copyBtn.classList.add('copied');
            copyBtn.innerHTML = `
                <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/>
                </svg>
                <span>${translations[userLang].copyBtnCopied}</span>
            `;
            
            setTimeout(() => {
                copyBtn.classList.remove('copied');
                copyBtn.innerHTML = originalContent;
            }, 2000);
        }


    </script>
</body>
</html>
